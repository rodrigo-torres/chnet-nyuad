/////APERTURA FILE, DISEGNO SPETTRO/////////////////////////////////////
Cliccare Draw/Redraw, fa scegliere il file.
Il pulsante Draw/Redraw è asincrono. Serve per disegnare lo spettro caricandolo dal file. Cliccandolo mette single_draw=true, histo_on=false e manda a DoDraw().
DoDraw() -> se single_draw=true -> legge il file e costruisce l'istogramma e lo disegna. Poi mette single_draw=false e histo_on=true (questo è true quando c'è uno spettro disegnato).
Ricliccando il pulsante si ridisegna da capo lo spettro(se ci sono fit o marker cancella tutto). Finchè non si è calibrato fa scegliere un file.
Dopo la calibrazione (vedi dopo...) DoDraw() -> se Calibration_ready=true -> ridisegna l'istogramma calibrato (da quando è calibrato non si passa più a canali)

SI PUÒ FARE ZOOM IN UNA ZONA CLICCANDO SULL'ASSE (tasto sinistro) COME SEMPRE IN ROOT, I FIT E LA CALIBRAZIONE FUNZIONANO LO STESSO

///////////////////FIT////////////////////////////////////////////////////////////////
Cliccare il pulsante Fit. Fare i tre click per definire range e picco (a volte non lo prende, perchè il timer è 250 ms, se non si vede il marker rosso ricliccare). Al terzo click fitta e stampa i risultati. 

Nel codice:
Il timer va a CmndList()
CmndList() controlla se c'è un click di mouse, ma funziona solo se il Fit (o la calibrazione) è abilitato (Fit_Enabled_bool): in questo caso salva la coordinata x corrispondente al punto cliccato e manda a DoDraw(). 
Attenzione! Finchè il mouse non è stato rilasciato non accetta un nuovo click (event_processed diventa falso quando è stato rilasciato il mouse). Senza questa condizione mantenendo il mouse cliccato lo vede come diversi click perchè il timer ritorna e rivede il mouse cliccato.

Cliccando il pulsante Fit va a RunFit()-> che mette FitEnabled_bool=true e disabilita il pulsante Fit. Poi rimanda a Dodraw().
DoDraw() -> se Fit_Enabled_bool -> prende la coordinata cliccata e disegna una linea rossa in corrispondenza. Questo lo fa per tre click consecutivi (tre volte CmndList viene qui) e finito di disegnare la terza linea mette la variabile fit_Ok=true (cioè dice che siamo pronti per lanciare il fit, i tre punti sono pronti) e va di nuovo a RunFit().

RunFit()-> se fit_ok=true prende le tre coordinate cliccate, cerca il max e il min per definire il range di fit e la coordinata del picco. Poi mette runfit=true e rimanda a DoDraw().

DoDraw() -> se runfit -> definisce una funzione gaussiana nel range min-max trovato, per fittare il picco. Fitta subito il picco con la gaussiana. Poi controlla il tipo di background scelto. Se non si vuole backgrond lascia valido il fit semplice gaussiano, sennò definisce le funzioni somma gaus+bkg opportune. In questo caso inizializza i parametri gaussiani a quelli trovati dal fit gaussiano e fitta lasciando liberi gli altri parametri della funzione somma.
Poi disegna le funzioni picco, bkg e somma e la legenda.
Mostra in una finestrina i risultati del fit, quando si clicca OK cancella tutto.
Alla fine mette runfit=false e riabilita il bottone Fit.     

///////////////////DOUBLE FIT////////////////////////////////////////////////
Cliccare il pulsante DoubleFit. Fare i sei click per definire range e picchi (a volte non lo prende, perchè il timer è 250 ms, se non si vede il marker ricliccare). I primi tre marker sono rossi, i secondi tre blu. Al sesto click fitta e stampa i risultati. 

Nel codice:
Cliccando il pulsante DoubleFit va a RunDoubleFit()-> che mette DoubleFitEnabled_bool=true e disabilita il pulsante DoubleFit.
CmndList()-> se DoubleFitEnabled_bool=true -> salva la coordinata x corrispondente al click e manda a DoubleDoDraw().

DoubleDoDraw() -> prende la coordinata cliccata e disegna una linea rossa o blu in corrispondenza. Questo lo fa per sei click consecutivi (sei volte CmndList viene qui) e finito di disegnare la sesta linea, se DoubleFitEnabled_bool, mette la variabile Doublefit_Ok=true (cioè dice che siamo pronti per lanciare il doppio fit, i sei punti sono pronti)e va di nuovo a RunDoubleFit().

RunDoubleFit()-> se Doublefit_Ok-> fitta i due range rosso e blu con gaussiane, poi prende i parametri e li usa per inizializzare la funzione somma. Controlla quale background è stato scelto e poi fa il fit totale. Alla fine rimette Doublefit_Ok=false, DoubleFitEnabled_bool=false e riabilita il pulsante DoubleFit.
Mostra in un messaggio i risultati del fit, cliccando Ok cancella tutto.


/////////////////////////////////////////////////////////////////////////////////////
//////CALIBRAZIONE//////////////////////////////////////////////////////////////
Cliccare Calibrate e fare tre click intorno al primo picco (marker rossi) e tre intorno al secondo (marker blu). Nelle finestre di dialogo vanno inseriti i valori in KeV di energia corrispondenti. Chiede prima il minore e poi il maggiore.

Nel codice:
Cliccando Calibrate, se l'istorgramma è on (histo_on) mette start_calibration=true, disabilita il pulsante Calibrate e rimanda a CalculateCal()
CmndList() controlla se c'è un click di mouse e se la calibrazione è abilitata (start_calibration) salva la coordinata x corrispondente al punto cliccato e manda a DoubleDoDraw().
Attenzione! Finchè il mouse non è stato rilasciato non accetta un nuovo click (event_processed diventa falso quando è stato rilasciato il mouse). Senza questa condizione mantenendo il mouse cliccato lo vede come diversi click perchè il timer ritorna e rivede il mouse cliccato.

DoubleDoDraw() -> prende la coordinata cliccata e disegna una linea rossa o blu in corrispondenza. Questo lo fa per sei click consecutivi (sei volte CmndList viene qui) e finito di disegnare la sesta linea, se start_calibration=true, mette la variabile cal_Ok=true (cioè dice che siamo pronti per lanciare il fit di calibrazione, i sei punti sono pronti) e va di nuovo a CalculateCal().

CalculateCal()-> se cal_Ok=true-> prende le sei coordinate cliccate, cerca i due range di fit e le coordinate dei picchi. Poi li fitta separatamente con due gassiane, si salva i parametri usciti dal fit, e chiede con dei dialog a quali energie corrispondono. Poi calcola la costante di calibrazione e l'offset e calibra l'istogramma f1. Poi mette single_draw=true e rimanda a DoDraw().
Alla fine mette Calibration_ready=true (da qui in poi lo spettro è calibrato e è plottato in energia).Il pulsante Calibrate non viene più abilitato.

DoDraw() -> se single_draw || Calibration_ready-> ridisegna l'istogramma in energia

Attenzione! La variabile Calibration_ready non viene rimessa falsa. Se si vuole rifare una calibrazione e ripartire dallo spettro in canali si deve chiudere e riaprire il programma, riaprendo il file da capo.

//////////////////////////////////////////////////////////////////////////////////////
